
&НаКлиенте
Процедура ОбщиеРеквизиты(Команда)
	
	ФункцииФормДокументов.ОткрытьОбщиеРеквизиты(ЭтаФорма);
	
КонецПроцедуры

&НаСервере
Процедура УправлениеВидимостьюДоступностью()
	
	Элементы.СтраницаВручную.Видимость 	= Не ПоКонтрагентуСписком;
	Элементы.СтраницаСписком.Видимость 	= ПоКонтрагентуСписком;
	Элементы.ГруппаКонтрагента.Видимость 	= ПоКонтрагентуСписком;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьИтоги()
	
	Сумма 			= ВзаиморасчетыКонтрагента.Итог("Сумма");	
	СуммаУпр	 	= ВзаиморасчетыКонтрагента.Итог("СуммаУпр");	
	Результат 		= ВзаиморасчетыКонтрагента.Итог("Результат");	
	РезультатУпр 	= ВзаиморасчетыКонтрагента.Итог("РезультатУпр");	
	
КонецПроцедуры 

#Область Типовые

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Заполним по умолчанию
	
	Если Объект.Ссылка.Пустая() Тогда ФункцииФормДокументов.ЗаполнитьЗначенияПоУмолчанию(ЭтаФорма, ЭтаФорма.Элементы) КонецЕсли;
	
	// Считаем контрагентов
	
	ТаблКонтрагентов = Объект.ПоПартнеру.Выгрузить(,"Контрагент");
	ТаблКонтрагентов.Свернуть("Контрагент");
	Контрагенты.Загрузить(ТаблКонтрагентов);
	
	// Обновим настройки и видимость
	
	ПоКонтрагентуСписком = Объект.ПоПартнеруСписком;
	ВзаиморасчетыКонтрагента.Загрузить(Объект.ПоПартнеру.Выгрузить());
	
	// Видимость
	
	УправлениеВидимостьюДоступностью();
					
КонецПроцедуры
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Запустим в фоне определения долга
	
	ОбновитьИтоги();
	ОбновитьИнформациюОДолге();
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	ТекущийОбъект.ПоПартнеруСписком = ПоКонтрагентуСписком;
	
	ТекущийОбъект.ПоПартнеру.Очистить();
	Если ПоКонтрагентуСписком Тогда
		Для Каждого Строка ИЗ ВзаиморасчетыКонтрагента Цикл ЗаполнитьЗначенияСвойств(ТекущийОбъект.ПоПартнеру.Добавить(), Строка) КонецЦикла; КонецЕсли;
		
	// Если выбран контрагент но по нему нет строк в основной таблице тогда добавим пустую строку для того чтобы видеть что мы с ним работали
	
	Для Каждого Строка Из Контрагенты Цикл
		Если ТекущийОбъект.ПоПартнеру.Найти(Строка.Контрагент, "Контрагент") = Неопределено Тогда
			ТекущийОбъект.ПоПартнеру.Добавить().Контрагент = Строка.Контрагент; КонецЕсли; КонецЦикла;

	
	
	//корректируем пустые ссылки
	Если НЕ ЗначениеЗаполнено(ТекущийОбъект.Заказ) и НЕ ТекущийОбъект.Заказ=Неопределено Тогда
		ТекущийОбъект.Заказ=Неопределено;
	КонецЕсли;	
	Если НЕ ЗначениеЗаполнено(ТекущийОбъект.ДокументОтгрузки) и НЕ ТекущийОбъект.ДокументОтгрузки=Неопределено Тогда
		ТекущийОбъект.ДокументОтгрузки=Неопределено;
	КонецЕсли;
	
	Для Каждого Стр Из ТекущийОбъект.ПоПартнеру Цикл
		
		Если НЕ ЗначениеЗаполнено(Стр.Заказ) и НЕ Стр.Заказ=Неопределено Тогда
			Стр.Заказ=Неопределено;
		КонецЕсли;	
		Если НЕ ЗначениеЗаполнено(Стр.ДокументОтгрузки) и НЕ Стр.ДокументОтгрузки=Неопределено Тогда
			Стр.ДокументОтгрузки=Неопределено;
		КонецЕсли;
		
	КонецЦикла;	
	
КонецПроцедуры

#КонецОбласти

#Область Поток

&НаСервере
Функция ИнформацияПоДолгуПолучена()
	
	СтруктураДолга = ПолучитьИзВременногоХранилища(АдресИнфДолга);
	Если СтруктураДолга = Неопределено Тогда
		Возврат Ложь;
		
	Иначе
		
		Если СтруктураДолга.Состояние = Поток.СостояниеВыполнено() Тогда
			
			ИнфСтр1 = СтруктураДолга.Результат.Инф1;
			ИнфСтр2 = СтруктураДолга.Результат.Инф2;
			ИнфСтр3 = СтруктураДолга.Результат.Инф3; 
			
			// Заполним предыдущий долг конрагента пока документ не будет проведен
			Если Не Объект.Проведен Тогда Объект.ДолгДоКорректировки = СтруктураДолга.Результат.Сумма КонецЕсли;
			
			Элементы.ГруппаИнфоТовара.Видимость = Истина;
			
		ИначеЕсли СтруктураДолга.Состояние = Поток.СостояниеОшибка() Тогда
			
			ОбщиеФункции.СообщитьТекст(СтруктураДолга.стрОшибки); КонецЕсли;
		
		Возврат Истина; КонецЕсли;
	
КонецФункции
&НаКлиенте
Процедура ПолучитьИнфОДолгеПостоянно()
	
	Если ИнформацияПоДолгуПолучена() Тогда
		ОтключитьОбработчикОжидания("ПолучитьИнфОДолгеПостоянно"); КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура ПолучитьИнфОДолге()
	
	Если Не ИнформацияПоДолгуПолучена() Тогда
		ПодключитьОбработчикОжидания("ПолучитьИнфОДолгеПостоянно", 1) КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура ОбновитьИнформациюОДолге()
	
	CRMКлиент.ИнформацияОДолгеНачало(ИнфСтр1, ИнфСтр2, ИнфСтр3);
	
	АдресИнфДолга = Поток.СобратьИнформациюОДолгеВФоне(Объект.Контрагент, УникальныйИдентификатор, Объект.ФормаОтношений);
	ПодключитьОбработчикОжидания("ПолучитьИнфОДолге", 0.1, Истина);
	
КонецПроцедуры
&НаКлиенте
Процедура ИнфСтрОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылка, СтандартнаяОбработка)
	
	CRMКлиент.ОбработатьНавигационнуюСсылку(НавигационнаяСсылка, СтандартнаяОбработка, ЭтаФорма);
	
КонецПроцедуры

#КонецОбласти

#Область Реквизиты

&НаСервере
Процедура ОрганизацияПриИзмененииНаСервере() Экспорт
	
	ФункцииФормДокументов.ОрганизацияПриИзменении(Объект);

КонецПроцедуры
&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	
	
	ОрганизацияПриИзмененииНаСервере();
	ОбновитьИнформациюОДолге();
	
КонецПроцедуры
&НаСервере
Процедура КонтрагентПриИзмененииНаСервере()
	
	ФункцииФормДокументов.КонтрагентПриИзменении(Объект);
	
КонецПроцедуры
&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	КонтрагентПриИзмененииНаСервере();
	ОбновитьИнформациюОДолге();
	
КонецПроцедуры

&НаКлиенте
Процедура ФормаОтношенийПриИзменении(Элемент)
	
	ОбновитьИнформациюОДолге();
	
	Элементы.Заказ.Видимость = ?(Объект.ФормаОтношений=ПредопределенноеЗначение("Перечисление.ФормаОтношений.Клиент"),Истина,Ложь);
	Элементы.ДокументОтгрузки.Видимость = ?(Объект.ФормаОтношений=ПредопределенноеЗначение("Перечисление.ФормаОтношений.Клиент"),Истина,Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоКонтрагентуСпискомПриИзменении(Элемент)
	
	УправлениеВидимостьюДоступностью();
	
КонецПроцедуры



#КонецОбласти

#Область Работа_со_списком

&НаСервере
Процедура ОбновитьВзаиморасчетыКонтрагента()
	
	// Соединяем что в таблице с остаткми в базе и выводим результат
	
	Запрос = Новый Запрос(СтрШаблон("
	|ВЫБРАТЬ  Табл.Контрагент, Табл.Организация, Табл.ФормаОтношений, Табл.Заказ, Табл.ДокументОтгрузки, Табл.Сумма, Табл.СуммаУпр ПОМЕСТИТЬ ТаблДока ИЗ &ТаблицаДока КАК Табл;
	|ВЫБРАТЬ 
	|	ЕСТЬNULL(Док.Контрагент, 		Рег.Контрагент) 	Контрагент, 
	|	ЕСТЬNULL(Док.Организация, 		Рег.Организация) 	Организация,
	|	ЕСТЬNULL(Док.ФормаОтношений, 	Рег.ФормаОтношений) ФормаОтношений, 
	|	ЕСТЬNULL(Док.Заказ, 			Неопределено) Заказ, 
	|	ЕСТЬNULL(Док.ДокументОтгрузки, 	Неопределено) ДокументОтгрузки, 
	|	ЕСТЬNULL(СуммаОстаток, 0) 		Остаток, 
	|	ЕСТЬNULL(СуммаУпрОстаток, 0) 	ОстатокУпр,
	|	ЕСТЬNULL(Док.Сумма, 0) 			Сумма, 
	|	ЕСТЬNULL(Док.СуммаУпр, 0),		СуммаУпр,
	|	ЕСТЬNULL(СуммаОстаток, 0) + ЕСТЬNULL(Док.Сумма, 0) 			Результат,
	|	ЕСТЬNULL(СуммаУпрОстаток, 0) + ЕСТЬNULL(Док.СуммаУпр, 0) 	РезультатУпр
	|ИЗ 
	|	РегистрНакопления.Взаиморасчеты.Остатки(%1, Контрагент В(&Контрагент)) Рег
	|
	|ПОЛНОЕ СОЕДИНЕНИЕ
	|	ТаблДока Док
	|ПО
	|	Док.Контрагент 		= Рег.Контрагент И
	|	Док.Организация 	= Рег.Организация И
	|	Док.ФормаОтношений 	= Рег.ФормаОтношений
	|
	|", ?(Объект.Ссылка.Пустая(), "", "&ДатаДок")));
	
	Запрос.УстановитьПараметр("ДатаДок", 		Объект.Дата);
	Запрос.УстановитьПараметр("Контрагенты", 	Контрагенты.Выгрузить().ВыгрузитьКолонку("Контрагент"));
	Запрос.УстановитьПараметр("ТаблицаДока", 	ВзаиморасчетыКонтрагента.Выгрузить());
	
	
	ВзаиморасчетыКонтрагента.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры


&НаКлиенте
Процедура ВзаиморасчетыКонтрагентаСуммаПриИзменении(Элемент)
	
	текДанные = Элементы.ВзаиморасчетыКонтрагента.ТекущиеДанные;
	Если текДанные <> Неопределено Тогда
		текДанные.Результат = текДанные.Остаток + текДанные.Сумма;
		ОбновитьИтоги(); КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура ВзаиморасчетыКонтрагентаРезультатСуммаПриИзменении(Элемент)
	
	текДанные = Элементы.ВзаиморасчетыКонтрагента.ТекущиеДанные;
	Если текДанные <> Неопределено Тогда
		текДанные.Сумма = текДанные.Результат - текДанные.Остаток;
		ОбновитьИтоги(); КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура ВзаиморасчетыКонтрагентаСуммаУпрПриИзменении(Элемент)
	
	текДанные = Элементы.ВзаиморасчетыКонтрагента.ТекущиеДанные;
	Если текДанные <> Неопределено Тогда
		текДанные.РезультатУпр = текДанные.ОстатокУпр + текДанные.СуммаУпр;
		ОбновитьИтоги(); КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура ВзаиморасчетыКонтрагентаРезультатСуммаУпрПриИзменении(Элемент)
	
	текДанные = Элементы.ВзаиморасчетыКонтрагента.ТекущиеДанные;
	Если текДанные <> Неопределено Тогда
		текДанные.СуммаУпр = текДанные.РезультатУпр - текДанные.ОстатокУпр; 
		ОбновитьИтоги(); КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Взаиморасчеты(Команда)
	
	СписокКонтрагентов = Новый Массив;
	Для каждого Строка Из Контрагенты Цикл Если СписокКонтрагентов.Найти(Строка.Контрагент) = Неопределено Тогда СписокКонтрагентов.Добавить(Строка.Контрагент) КонецЕсли; КонецЦикла;
	
		ОткрытьФорму("Отчет.Взаиморасчеты.ФормаОбъекта", Новый Структура("СформироватьПриОткрытии, Отбор", Истина, Новый Структура("Контрагент", СписокКонтрагентов)), ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура Обнулить(Команда)
	
	Для Каждого Строка ИЗ ВзаиморасчетыКонтрагента Цикл 
		Строка.Результат = 0; 		Строка.Сумма = Строка.Остаток * -1;
		Строка.РезультатУпр = 0; 	Строка.СуммаУпр = Строка.ОстатокУпр * -1; КонецЦикла;
	
	ОбновитьИтоги();
		
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	ОбновитьИтоги();
	ОбновитьИнтерфейс();
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
	ОбновитьИтоги();
	ОбновитьИнтерфейс();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	текКонтрагент = Элементы.Контрагенты.ТекущиеДанные.Контрагент;
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентыПриАктивизацииСтроки(Элемент)
	
	текДанные = Элементы.Контрагенты.ТекущиеДанные;
	Если текДанные <> Неопределено Тогда
		текКонтрагент = текДанные.Контрагент; 
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти