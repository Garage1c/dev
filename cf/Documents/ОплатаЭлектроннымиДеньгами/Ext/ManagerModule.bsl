Процедура ИницилизироватьДополнительныеДанныеДокумента(Ссылка, ДополнительныеСвойства) Экспорт
	
	Запрос = Новый Запрос(
	
	КэшируемыеФункции.ТектЗапросаПолученияПараметровСистемы() + "
	|;
	|ВЫБРАТЬ
	|	ИнтернетЗаказПокупателя, ЭлектронныйКошелек, Контрагент
	|ИЗ
	|	Документ.ОплатаЭлектроннымиДеньгами
	|ГДЕ
	|	Ссылка = &Ссылка
	|;
	|" + 
	РаботаСКурсамиВалют.ПолучитьТекстЗапросаКурсыВалют() + "
	|;
	
	// ВЗАИМОРАСЧЕТЫ
	
	|ВЫБРАТЬ
	|	&Период				КАК Период,
	|	ВЫБОР 
	|		КОГДА Док.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЧекККМ.Возврат)
	|		ТОГДА &ВидДвиженияПриход
	|		ИНАЧЕ &ВидДвиженияРасход
	|	КОНЕЦ 											ВидДвижения,
	|	&Организация							 		Организация, 
	|	Док.Партнер					 					Партнер,
	|	Док.Контрагент 									Контрагент,
	|	ЗНАЧЕНИЕ(Перечисление.ФормаОтношений.Клиент) 	ФормаОтношений,	
	|	Док.Сумма					 					Сумма, " + 
		РаботаСКурсамиВалют.ПолучитьСуммуУпрВЗапросе("Док.Сумма") + " СуммаУпр
	|ИЗ
	|	Документ.ОплатаЭлектроннымиДеньгами Док
	|	ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют ПО ИСТИНА
	|ГДЕ
	|	Док.Ссылка = &Ссылка
	|;
	
	//// ОПЛАТЫ
	//
	//|ВЫБРАТЬ
	//|	&Период					Период,
	//|	Ссылка 					ДокументОплаты,
	//|	ВЫБОР КОГДА Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЧекККМ.Возврат)
	//|		ТОГДА -0   //при возврате комиссия не возвращается
	//|		ИНАЧЕ  СуммаКомиссии
	//|		КОНЕЦ  СуммаКомиссии,
	//|	ИнтернетЗаказПокупателя	Заказ,
	//|	Партнер,
	//|	Организация,
	//|	ВЫБОР КОГДА Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЧекККМ.Возврат)
	//|		ТОГДА -Сумма
	//|		ИНАЧЕ  Сумма
	//|		КОНЕЦ  Сумма
	//|ИЗ
	//|	Документ.ОплатаЭлектроннымиДеньгами
	//|ГДЕ
	//|	Ссылка = &Ссылка И ИнтернетЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ИнтернетЗаказПокупателя.ПустаяСсылка)
	//|;
	//
	//// АВАНСЫ
	//
	//|ВЫБРАТЬ
	//|	&Период				Период,
	//|	&ВидДвиженияПриход 	ВидДвижения,
	//|	Док.Партнер				Партнер,
	//|	Док.Ссылка 				ДокументОплаты,
	//|	ВЫБОР КОГДА Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЧекККМ.Возврат)
	//|		ТОГДА -Сумма
	//|		ИНАЧЕ  Сумма
	//|		КОНЕЦ  Сумма
	//|ИЗ
	//|	Документ.ОплатаЭлектроннымиДеньгами Док
	//|ГДЕ
	//|	Ссылка = &Ссылка И ИнтернетЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ИнтернетЗаказПокупателя.ПустаяСсылка)
	//|;
	
	// Денежные средства в пути
	
	|ВЫБРАТЬ
	|	&Период				Период,
	|	&ВидДвиженияПриход 	ВидДвижения,
	|	Док.ОператорПлатежнойСистемы	Контрагент,
	|	Значение(Перечисление.ВидыОперацииДенежныеСредстваВПути.ОплатаПокупателем)	ВидОперации,
	|	ВЫБОР КОГДА Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЧекККМ.Возврат)
	|		ТОГДА -Сумма
	|		ИНАЧЕ  Сумма
	|		КОНЕЦ  Сумма
	|ИЗ
	|	Документ.ОплатаЭлектроннымиДеньгами Док
	|ГДЕ
	|	Ссылка = &Ссылка 
	|
	|Объединить Все
	|
	|ВЫБРАТЬ
	|	&Период				Период,
	|	&ВидДвиженияРасход 	ВидДвижения,
	|	Док.ОператорПлатежнойСистемы	Контрагент,
	|	Значение(Перечисление.ВидыОперацииДенежныеСредстваВПути.УдержаниеКомиссии)	ВидОперации,
	|	ВЫБОР КОГДА Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЧекККМ.Возврат)
	|		ТОГДА 0 //комиссия не возвращается при возврате
	|		ИНАЧЕ  СуммаКомиссии
	|		КОНЕЦ  Сумма
	|ИЗ
	|	Документ.ОплатаЭлектроннымиДеньгами Док
	|ГДЕ
	|	Ссылка = &Ссылка
	|;
	
	// ДОЛГИ КОНТРАГЕНТОВ
	
	//|ВЫБРАТЬ 
	//|	&ВидОперацииОплата ВидОперации, &ФормаОтношений ФормаОтношений, Док.Организация, Док.Контрагент, Ссылка Документ, Док.Дата Дата, Док.Дата Период,
	//|	ЕСТЬNULL(СуммаУпрОстаток, 0) - " + РаботаСКурсамиВалют.ПолучитьСуммуУпрВЗапросе("Док.Сумма") + " Сумма
	////|	ЕСТЬNULL(СуммаУпрОстаток, 0) СуммаВзаиморасчеты
	//|ИЗ
	//|	РегистрНакопления.Взаиморасчеты.Остатки(&Период, Организация = &Организация И Контрагент = &Контрагент)
	//|
	//|ПРАВОЕ СОЕДИНЕНИЕ
	//|	(ВЫБРАТЬ Дата, &Организация Организация, Контрагент, Ссылка, Сумма ИЗ Документ.ОплатаЭлектроннымиДеньгами ГДЕ Ссылка = &Ссылка) Док
	//|ПО ИСТИНА
	//|
	//|ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют ПО ИСТИНА
	//|;

	// ДОЛГИ ПО ОТГРУЗКАМ
	
	|ВЫБРАТЬ
	|	&Период				КАК Период,
	|	&ВидДвиженияРасход	 	ВидДвижения,
	|	Партнер			Партнер,
	|	Контрагент		Контрагент,
	|	Организация		Организация,
	|	Выбор когда ИнтернетЗаказПокупателя=Значение(Документ.интернетЗаказПокупателя.ПустаяСсылка) Тогда Неопределено Иначе ИнтернетЗаказПокупателя Конец					Заказ,
	|	Выбор когда ДокументОтгрузки=Значение(Документ.РеализацияТоваров.ПустаяСсылка) Тогда Неопределено Иначе ДокументОтгрузки Конец					ДокументОтгрузки,
	|	Выбор когда Ссылка.ВидОперации=&Продажа Тогда Сумма Иначе -Сумма Конец	Сумма
	|
	|ИЗ
	|	Документ.ОплатаЭлектроннымиДеньгами 
	|ГДЕ
	|	Ссылка = &Ссылка
	|
	|;
	
	// Долги по заказам
	
	|ВЫБРАТЬ
	|	&Период						Период,
	|	&ВидДвиженияРасход 			ВидДвижения,
	|	Организация					Организация,
	|	Партнер						Партнер,
	|	&Менеджер				 	Менеджер,
	|	Контрагент					Контрагент,      
	|	Выбор когда ИнтернетЗаказПокупателя=Значение(Документ.интернетЗаказПокупателя.ПустаяСсылка) Тогда Неопределено Иначе ИнтернетЗаказПокупателя Конец					Заказ,
	|	Выбор когда Ссылка.ВидОперации=&Продажа Тогда Сумма Иначе -Сумма Конец	Сумма
	|ИЗ
	|	Документ.ОплатаЭлектроннымиДеньгами
	|ГДЕ
	|	Ссылка = &Ссылка
	|");
	
	
	//Запрос.УстановитьПараметр("Область", 			ПараметрыСеанса.ТекущаяОбласть);	
	Запрос.УстановитьПараметр("Ссылка", 			Ссылка);
	Запрос.УстановитьПараметр("Период", 			Ссылка.Дата);
	Запрос.УстановитьПараметр("Валюта", 			Ссылка.Валюта);
	Запрос.УстановитьПараметр("ВидДвиженияРасход", 	ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("ВидДвиженияПриход", 	ВидДвиженияНакопления.Приход);
	Запрос.УстановитьПараметр("Возврат", 			Перечисления.ВидыОперацийЧекККМ.Возврат);
	Запрос.УстановитьПараметр("Продажа", 			Перечисления.ВидыОперацийЧекККМ.Продажа);
	Запрос.УстановитьПараметр("Менеджер", 			Справочники.Контрагенты.ПолучитьОсновногоМенеджераПартнера(Ссылка.Дата, Ссылка.Контрагент));
	
	Запрос.УстановитьПараметр("Организация", 		Ссылка.Организация);
	Запрос.УстановитьПараметр("Контрагент", 		Ссылка.Контрагент);
	Запрос.УстановитьПараметр("ВидОперацииОплата", 	Перечисления.ВидыОперацийВзаиморасчетов.Оплата);
	Запрос.УстановитьПараметр("ФормаОтношений", 	Перечисления.ФормаОтношений.Клиент);
	
	
	Пакет = Запрос.ВыполнитьПакет();
	
	ДополнительныеСвойства.Вставить("ПараметрыСистемы", КонвертацияТипов.ПолучитьСтруктуруИзСТрокиТаблицыЗначений(Пакет[0].Выгрузить()));
	ДополнительныеСвойства.Вставить("Шапка", 			КонвертацияТипов.ПолучитьСтруктуруИзСТрокиТаблицыЗначений(Пакет[1].Выгрузить()));
	ДополнительныеСвойства.Вставить("Взаиморасчеты", 	Пакет[3].Выгрузить());
	//ДополнительныеСвойства.Вставить("Оплаты", Пакет[4].Выгрузить());
	//ДополнительныеСвойства.Вставить("Авансы", Пакет[5].Выгрузить());
	ДополнительныеСвойства.Вставить("ДенежныеСредстваВПути", Пакет[4].Выгрузить());
	//ДополнительныеСвойства.Вставить("ДолгиКонтрагентов", Пакет[7].Выгрузить());
	ДополнительныеСвойства.Вставить("ДолгиПоОтгрузкам", Пакет[5].Выгрузить());
	ДополнительныеСвойства.Вставить("ДолгиПоЗаказам", Пакет[6].Выгрузить());
	
КонецПроцедуры
