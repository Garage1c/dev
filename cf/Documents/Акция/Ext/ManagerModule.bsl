    
Процедура ИницилизироватьДополнительныеДанныеДокумента(Ссылка, ДополнительныеСвойства) Экспорт
	
	Запрос = Новый Запрос(
	         
	КэшируемыеФункции.ТектЗапросаПолученияПараметровСистемы() + "
	|;
	
	// ШАПКА
	
	|ВЫБРАТЬ
	|	Автор, Ответственный
	|ИЗ
	|	Документ.Акция
	|ГДЕ
	|	Ссылка = &Ссылка
	|;
	
	|ВЫБРАТЬ
	|	Ссылка Акция, Ссылка.ДатаНачала ДатаНачала, Ссылка.ДатаОкончания ДатаОкончания,  Ссылка.Валюта Валюта, Ссылка.ВариантСкидки ВариантСкидки,  Ссылка.ВариантРасчета ВариантРасчета,
	|	Номенклатура, ТипЦен, ПроцентСкидки, НоваяЦена, Цена 
	|ПОМЕСТИТЬ ТоварыДокумента
	|ИЗ Документ.Акция.Товары 
	|ГДЕ 
	|	Ссылка = &Ссылка
	|;
	
	|ВЫБРАТЬ
	|	Ссылка Акция, Ссылка.ДатаНачала ДатаНачала, Ссылка.ДатаОкончания ДатаОкончания, Ссылка.Валюта, Участник 
	|ПОМЕСТИТЬ УчастникиДокумента
	|ИЗ Документ.Акция.Участники 
	|ГДЕ 
	|	Ссылка = &Ссылка
	|;
	
	// АКЦИЯ
	
	|ВЫБРАТЬ	ДатаНачала Период, Акция,  Валюта, Номенклатура, ТипЦен, НоваяЦена, ПроцентСкидки, ВариантСкидки, ВариантРасчета
	|ИЗ         ТоварыДокумента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ	ДатаОкончания Период, &ПустаяАкция Акция, Валюта, Номенклатура, ТипЦен, 0 НоваяЦена, 0 ПроцентСкидки,  ВариантСкидки, ВариантРасчета
	|ИЗ			ТоварыДокумента
	|ГДЕ		ДатаОкончания <> ДАТАВРЕМЯ(1,1,1,0,0,0) 
	|;
	|
	|ВЫБРАТЬ ДатаНачала Период, Акция, Валюта, Участник, Номенклатура, НоваяЦена 
	|ИЗ УчастникиДокумента
	|	ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ Номенклатура, МАКСИМУМ(НоваяЦена) НоваяЦена ИЗ ТоварыДокумента СГРУППИРОВАТЬ ПО Номенклатура) Тов ПО ИСТИНА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ДатаОкончания Период, &ПустаяАкция Акция, Валюта, Участник, Номенклатура, НоваяЦена
	|ИЗ УчастникиДокумента
	|	ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ Номенклатура, МАКСИМУМ(НоваяЦена) НоваяЦена ИЗ ТоварыДокумента СГРУППИРОВАТЬ ПО Номенклатура) Тов ПО ИСТИНА
	|ГДЕ ДатаОкончания <> ДАТАВРЕМЯ(1,1,1,0,0,0)	
	|");
	

	//Запрос.УстановитьПараметр("Область", 		ПараметрыСеанса.ТекущаяОбласть);
	Запрос.УстановитьПараметр("Ссылка", 		Ссылка);
	Запрос.УстановитьПараметр("ПустаяАкция", 	Документы.Акция.ПустаяСсылка());
	
	Пакет = Запрос.ВыполнитьПакет();
	
	ДополнительныеСвойства.Вставить("ПараметрыСистемы", 		КонвертацияТипов.ПолучитьСтруктуруИзСТрокиТаблицыЗначений(Пакет[0].Выгрузить()));
	ДополнительныеСвойства.Вставить("Шапка", 					КонвертацияТипов.ПолучитьСтруктуруИзСТрокиТаблицыЗначений(Пакет[1].Выгрузить()));
	
	// пока так...
	Если Ссылка.Участники.Количество() Тогда
		  ДополнительныеСвойства.Вставить("УчастникиАкции", Пакет[5].Выгрузить());
	Иначе
		ДополнительныеСвойства.Вставить("Акция", Пакет[4].Выгрузить());
	КонецЕсли
	
	                       
КонецПроцедуры


Процедура ОбработкаПолученияПредставления(Данные, Представление, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	Представление = "Акция " + """" + Данные.Ссылка.Наименование + """ от " + Данные.Дата;
КонецПроцедуры

