&НаКлиенте
Перем СтруктураКолонокТовары Экспорт;

#Область Картинки

&НаСервере
Процедура СчитатьКоличествоКартинок()
	
	Запрос = Новый Запрос("ВЫБРАТЬ КОЛИЧЕСТВО(Ссылка) Количество, Владелец Номенклатура ИЗ Справочник.КартинкиНоменклатуры ГДЕ Владелец В(ВЫБРАТЬ Номенклатура ИЗ Справочник.Новинки.Товары ГДЕ Ссылка = &Ссылка) СГРУППИРОВАТЬ ПО Владелец");
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл Объект.Товары.НайтиСтроки(Новый Структура("Номенклатура", Выборка.Номенклатура))[0].КоличествоКартинок = Выборка.Количество; КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьКоличествоКартинок(НоменклатураСсылка)
	
	Запрос = Новый Запрос("ВЫБРАТЬ КОЛИЧЕСТВО(Ссылка) Количество ИЗ Справочник.КартинкиНоменклатуры ГДЕ Владелец = &Ссылка");
	Запрос.УстановитьПараметр("Ссылка", НоменклатураСсылка);
	
	Выполнение = Запрос.Выполнить();
	Если Выполнение.Пустой() Тогда Возврат 0 КонецЕсли;
	
	Выборка = Выполнение.Выбрать();
	Выборка.Следующий();
	Возврат Выборка.Количество;
	
КонецФункции

&НаКлиенте
Процедура ТоварыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	ТекДанные = Элемент.ТекущиеДанные;
	ТекДанные.КоличествоКартинок = ПолучитьКоличествоКартинок(ТекДанные.Номенклатура);
	
КонецПроцедуры


#КонецОбласти

#Область Типовые

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Объект.Ссылка.Пустая() Тогда
		Объект.ДатаНовинок = ТекущаяДата();
	КонецЕсли;
	
	// Получим количество картинок
	СчитатьКоличествоКартинок();
	
	// информация о товаре
	РаботаСНоменклатурой.ДобавитьОперативнуюИнформациюОТоваре(ЭтаФорма);
	
КонецПроцедуры
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	СтруктураКолонокТовары = ФункцииФормДокументов.ПолучитьСтруктуруКолонокТовары(Элементы.Товары, Истина);
	
КонецПроцедуры

#КонецОбласти

#Область Даты

&НаКлиенте
Процедура УстановитьДатуВВыделенныеСтроки(Дата, Параметры) Экспорт
	
	Если Дата <> Неопределено Тогда
		Для Каждого Строка Из Элементы.Товары.ВыделенныеСтроки Цикл Модифицированность = Истина; Объект.Товары.НайтиПоИдентификатору(Строка).ПериодДействия = Дата КонецЦикла; КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура УстановитьПериодДействия(Команда)
	
	ПоказатьВводДаты(Новый ОписаниеОповещения("УстановитьДатуВВыделенныеСтроки", ЭтаФорма),,"Период действия новинки", ЧастиДаты.Дата);
	
КонецПроцедуры

#КонецОбласти

#Область Информация // о товаре

&НаКлиенте
Процедура ТоварыПриАктивизацииСтроки(Элемент)
	
	// информация о товаре
	ОбработатьОтображениеИнформацииОТоваре()	
	 	
КонецПроцедуры
&НаСервере
Процедура ОбработатьОтображениеИнформацииОТоваре() Экспорт 
	РаботаСНоменклатурой.ОбработатьОтображениеИнформацииОТоваре(ЭтаФорма, "Товары", "Объект.Товары");
КонецПроцедуры

&НаКлиенте
Процедура ИнфТовараТекстHTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
	РаботаСНоменклатуройКлиент.ИнфТовараТекстHTMLПриНажатии(ЭтаФорма, Элемент, ДанныеСобытия, СтандартнаяОбработка);
КонецПроцедуры
&НаКлиенте
Процедура ИнфТовараЗаголовокHTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
	РаботаСНоменклатуройКлиент.ИнфТовараЗаголовокHTMLПриНажатии(ЭтаФорма, Элемент, ДанныеСобытия, СтандартнаяОбработка, "Товары", "Объект.Товары");
КонецПроцедуры

 &НаКлиенте
Процедура ПоказатьСкрытьИнфОТоваре(Команда)
	РаботаСНоменклатуройКлиент.ПоказатьСкрытьИнфОТоваре(ЭтаФорма);
КонецПроцедуры
&НаКлиенте
Процедура НастройкаИнфОТоваре(Команда) 
	РаботаСНоменклатуройКлиент.НастройкаИнфОТоваре(ЭтаФорма, "Товары", "Объект.Товары");
КонецПроцедуры

#КонецОбласти

#Область Управление

&НаСервере
Процедура ИзменитьВыгружатьНаСайт(Флаг, ИмяСвойства = "ВыгружатьНаСайт")
	
	НачатьТранзакцию();
	
	Для Каждого Инд Из Элементы.Товары.ВыделенныеСтроки Цикл
		
		СправочникОбъект = Объект.Товары.Получить(Инд).Номенклатура.ПолучитьОбъект();
		СправочникОбъект[ИмяСвойства] = Флаг;
		
		Попытка
			СправочникОбъект.Записать();
		Исключение
			ОбщиеФункции.СообщитьТекст(ОписаниеОшибки());
			ОтменитьТранзакцию();
			Возврат;
		КонецПопытки;
		
	КонецЦикла;
	
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры
&НаКлиенте
Процедура УстановитьВыгружатьНаСайт(Команда)
	
	ИзменитьВыгружатьНаСайт(Истина);
	ОтобразитьИзменениеДанных(Объект.Товары, ВидИзмененияДанных.Изменение);
	//ОбновитьОтображениеДанных();
	//Элементы.Товары.Обновить();
	
КонецПроцедуры
&НаКлиенте
Процедура СнятьВыгружатьНаСайт(Команда)
	
	ИзменитьВыгружатьНаСайт(Ложь);
	ОбновитьОтображениеДанных();
	//Элементы.Товары.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьВыгружатьВыгружатьДляДилеров(Команда)
	
	ИзменитьВыгружатьНаСайт(Ложь, "ДляДилеров");
	Элементы.Товары.Обновить();
	
КонецПроцедуры
&НаКлиенте
Процедура УстановитьВыгружатьДляДилеров(Команда)
	
	ИзменитьВыгружатьНаСайт(Истина, "ДляДилеров");
	Элементы.Товары.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьГотовностьВсем(Команда)
	Для Каждого Строка Из Элементы.Товары.ВыделенныеСтроки Цикл
		Модифицированность = Истина;
		Объект.Товары.НайтиПоИдентификатору(Строка).Готовность = Истина
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура УбратьГотовностьВсем(Команда)
	Для Каждого Строка Из Элементы.Товары.ВыделенныеСтроки Цикл
		Модифицированность = Истина;
		Объект.Товары.НайтиПоИдентификатору(Строка).Готовность = Ложь
	КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура ПодборНовинок(Команда)
	
	ОткрытьФорму("Справочник.Новинки.Форма.ПодборНовинок",, Элементы.Товары);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если ВыбранноеЗначение = Неопределено Тогда
		Возврат
	КонецЕсли;
	ЗагрузитьИзВременногоХранилища(ВыбранноеЗначение);

КонецПроцедуры

Процедура ЗагрузитьИзВременногоХранилища(Адрес)
	
	Таблица = ПолучитьИзВременногоХранилища(Адрес);
	КонвертацияТипов.ДобавитьТаблицуКДругойТаблице(Объект.Товары, Таблица);
	
КонецПроцедуры


#КонецОбласти

#Область Корзина

#Если Не ВебКлиент Тогда
&НаСервере
Функция ПоложитьВКорзинуНаСервере(ВыделенныеИндексы, ИмяКомпа, КолВКорзине)
	
	Возврат МодульКорзины.ПоложитьТоварВКорзину(Объект.Товары, ВыделенныеИндексы, ИмяКомпа, КолВКорзине);
	
КонецФункции
#КонецЕсли

#Если Не ВебКлиент Тогда
&НаКлиенте
Процедура ДобавитьВКорзину(Команда)
	
	ВыделенныеИндексы 	= МодульКорзины.ПолучитьВыделенныеСтрокиТоваров(Элементы.Товары, Объект.Товары);
	КолВКорзине 		= 0;
	КолТовара			= ВыделенныеИндексы.Количество();
	
	
	Если КолТовара Тогда
		
		Если ПоложитьВКорзинуНаСервере(ВыделенныеИндексы, ИмяКомпьютера(), КолВКорзине) Тогда
			МодульКорзины.ОповеститьОПомещенииТовара(КолТовара, КолВКорзине);
		КонецЕсли;
		
	Иначе
		
		МодульКорзины.ОповеститьЧтоНечегоДобавлять();
				
	КонецЕсли;
	
КонецПроцедуры
#КонецЕсли

#Если Не ВебКлиент Тогда
&НаСервере
Процедура ДобавитьИзКорзиныНаСервере(ИмяКомпа, СтруктураКолонокТовары, КолСтрок)
	
	МодульКорзины.ПолучитьТоварИзКорзины(Элементы.Товары, Объект.Товары, СтруктураКолонокТовары, ИмяКомпа, КолСтрок);
	
КонецПроцедуры
#КонецЕсли

#Если Не ВебКлиент Тогда
&НаКлиенте
Процедура ВставитьИзКорзины(Команда)
	
	КолСтрок = 0;
	ДобавитьИзКорзиныНаСервере(ИмяКомпьютера(), СтруктураКолонокТовары, КолСтрок);
	
	Если КолСтрок Тогда
		
		МодульКорзины.ОповеститьОВставкеТовараВДокумент(КолСтрок, Объект.Товары.Количество());
		
	Иначе
		
		МодульКорзины.ОповеститьЧтоНечегоДобавлять();
		
	КонецЕсли;
	
КонецПроцедуры
#КонецЕсли

#Если Не ВебКлиент Тогда
&НаКлиенте
Процедура РедактироватьТоварВКорзине(Команда)
	
	ОткрытьФорму("РегистрСведений.Корзина.Форма.Форма");
	
КонецПроцедуры
#КонецЕсли

#Если Не ВебКлиент Тогда
&НаСервере
Функция ОчиститьНаСервере(ИмяКомпа)
	
	Возврат МодульКорзины.ОчиститьКорзину(ИмяКомпа);
	
КонецФункции
#КонецЕсли

#Если Не ВебКлиент Тогда
&НаКлиенте
Процедура ОчиститьКорзину(Команда)
	
	Если ОчиститьНаСервере(ИмяКомпьютера()) Тогда
		
		МодульКорзины.ОповеститьЧтоКорзинаОчищена();
		
	КонецЕсли;
	
КонецПроцедуры
#КонецЕсли

&НаКлиенте
Процедура ПечатьНовинки(Команда)
	ПараметрыФормы = Новый Структура("Новинка", Объект.Ссылка);
	ОткрытьФорму("Обработка.ПечатьНовинок.Форма.Форма",ПараметрыФормы);
КонецПроцедуры


#КонецОбласти
