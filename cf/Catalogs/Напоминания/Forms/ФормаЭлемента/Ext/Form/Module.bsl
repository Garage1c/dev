
&НаКлиенте
Перем НапоминанияБольшеНет;

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// зАПИШЕМ ЧТО НАПОМИНАНИЕ ОТКРЫЛИ
	
	Если Не ЗаписатьОткрытие() Тогда
		
		Отказ = Истина;
		
	КонецЕсли;
	
	СледующееНапоминание = ТекущаяДата();
	
	Заголовок = Объект.Источник;
	НапомнитЕщеРаз = Перечисления.ПериодыНапоминаний._10;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	
	// Запишем что напоминание закрыли
	
	Если НапоминанияБольшеНет <> Истина Тогда
		
		ЗаписатьНапоминание();
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ОпределитьВремяСледующегоНапоминания()
	
	Если НапомнитЕщеРаз = Перечисления.ПериодыНапоминаний.Завтра Тогда
		
		СледующееНапоминание = НачалоДня(ТекущаяДата() + 86400);
		
	ИначеЕсли НапомнитЕщеРаз = Перечисления.ПериодыНапоминаний.НаСледующейНедели Тогда
		
		СледующееНапоминание = НачалоНедели(ТекущаяДата() + 86400 * 7);
		
	ИначеЕсли НапомнитЕщеРаз = Перечисления.ПериодыНапоминаний.ВСледующемМесяце Тогда
		
		СледующееНапоминание = НачалоМесяца(КонецМесяца(ТекущаяДата()) + 1);
		
	ИначеЕсли НапомнитЕщеРаз = Перечисления.ПериодыНапоминаний.ВНовомГоду Тогда
		
		СледующееНапоминание = НачалоГода(КонецГода(ТекущаяДата()) + 1);
		
	Иначе
		
		СледующееНапоминание = ТекущаяДата() + Число(СтрЗаменить(Строка(НапомнитЕщеРаз.Метаданные().ЗначенияПеречисления[Перечисления.ПериодыНапоминаний.Индекс(НапомнитЕщеРаз)].Имя),"_","")) * 60;
		
	КонецЕсли;
	
КонецФункции

// ЗАПИСЬ

&НаСервере
Функция ЗаписатьОткрытие()
	
	текОбъект = Объект.Ссылка.ПолучитьОбъект();
	
	Если текОбъект <> Неопределено Тогда
		
		текОбъект.НапоминаниеОткрыл 	= ПараметрыСеанса.ТекущийПользователь;
		текОбъект.НапоминаниеОткрыто 	= ТекущаяДата();
		
		Попытка
			текОбъект.Записать();
		Исключение
			ОбщиеФункции.СообщитьТекст(ОписаниеОшибки());
			Возврат Ложь;
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции
&НаСервере
Функция ЗаписатьНапоминание()
	
	текОбъект = Объект.Ссылка.ПолучитьОбъект();
	
	Если текОбъект <> Неопределено Тогда
		
		текОбъект.ДатаНапоминания 		= СледующееНапоминание;
		текОбъект.НапоминаниеОткрыто 	= '00010101';
		текОбъект.НапоминаниеОткрыл 	= Справочники.Пользователи.ПустаяСсылка();
		
		Попытка
			текОбъект.Записать();
		Исключение
			ОбщиеФункции.СообщитьТекст(ОписаниеОшибки());
			Возврат Ложь;
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции
&НаСервере
Функция УдалитьНапоминание()
	
	текОбъект = Объект.Ссылка.ПолучитьОбъект();
	
	Если текОбъект <> Неопределено Тогда
		
		Попытка
			текОбъект.Удалить();
		Исключение
			ОбщиеФункции.СообщитьТекст(ОписаниеОшибки());
			Возврат Ложь;
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// КНОПКИ

&НаКлиенте
Процедура ОткрытьИБольшеНеНапоминать(Команда)
	
	ОткрытьФорму("Задача.ЗадачаПользователю.ФормаОбъекта", Новый Структура("Ключ", Объект.Источник));
	УдалитьНапоминание();
	НапоминанияБольшеНет = Истина;
	Закрыть();
	
КонецПроцедуры
&НаКлиенте
Процедура НапомнитьПозже(Команда)
	
	ОпределитьВремяСледующегоНапоминания();
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура ПерейтиНадписьНажатие(Элемент)
	
	ОткрытьФорму("Задача.ЗадачаПользователю.ФормаОбъекта", Новый Структура("Ключ", Объект.Источник));
	Закрыть();
	
КонецПроцедуры
