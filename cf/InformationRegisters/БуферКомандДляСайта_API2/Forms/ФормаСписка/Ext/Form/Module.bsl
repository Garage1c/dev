
&НаКлиенте
Процедура ОбнулитьВсеФлагиОшибок(Команда)
	
	ОбнулитьВсеФлагиОшибокНаСервере();
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьЗаписьСОшибкой()
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1 Объект ИЗ РегистрСведений.БуферКомандДляСайта_API2 ГДЕ ЕстьОшибка");
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Запись = РегистрыСведений.БуферКомандДляСайта_API2.СоздатьМенеджерЗаписи();
		Запись.Объект = Выборка.Объект;
		Запись.Прочитать();
		Возврат Запись; КонецЕсли;
	
КонецФункции
&НаСервереБезКонтекста
Процедура ОбнулитьВсеФлагиОшибокНаСервере()
	
	Запись = ПолучитьЗаписьСОшибкой();
	Пока Запись <> Неопределено Цикл 
		
		Запись.ЕстьОшибка 				= Ложь;
		Запись.НомерПовтораПриОшибке 	= 0;
		
		Если Не ОбщиеФункции.ЗаписатьОбъектИСообщитьЕслиОшибка(Запись) Тогда 
			Прервать КонецЕсли; 
		
		Запись = ПолучитьЗаписьСОшибкой(); КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ОтправитьЗапросНаСервере(ОдинОбъект, СайтНазначения)
	текстЛога = "";
	API2.ОтправлениеЗапросовСайту_API2(ТекстЛога, ОдинОбъект, СайтНазначения);
	
	Сообщить(текстЛога);
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьЗапрос(Команда)
	текДанные = Элементы.Список.ТекущиеДанные;
	Если текДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ОтправитьЗапросНаСервере(текДанные.Объект, текДанные.СайтНазначения);
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ОбновитьСтатистику();
КонецПроцедуры


&НаСервере
Процедура ОбновитьСтатистику()
	ТабСтатистика.Очистить();
	
	//считаем только ошибки обработки сайтом (коды 500 и 402)
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	БуферКомандДляСайта_API2.СайтНазначения,
	             |	СУММА(1) КАК ВсегоЗаписей,
	             |	СУММА(ВЫБОР
	             |			КОГДА БуферКомандДляСайта_API2.КодОшибки = 500
	             |					ИЛИ БуферКомандДляСайта_API2.КодОшибки = 402
	             |				ТОГДА 1
	             |			ИНАЧЕ 0
	             |		КОНЕЦ) КАК ОшибокОбработки
	             |ИЗ
	             |	РегистрСведений.БуферКомандДляСайта_API2 КАК БуферКомандДляСайта_API2
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	БуферКомандДляСайта_API2.СайтНазначения";
	ТабСтатистика.Загрузить(Запрос.Выполнить().Выгрузить());			 
КонецПроцедуры

&НаКлиенте
Процедура Обновить2(Команда)
	Элементы.Список.Обновить();
	ОбновитьСтатистику();
КонецПроцедуры
